<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using dmsetup to Salvage Disks with Bad Blocks | Thoughts, stories and ideas</title>
<meta name=keywords content="linux,storage,dmsetup,zfs,badblocks"><meta name=description content="A guide to rescuing disks with bad blocks using dmsetup, avoiding the need for costly replacements."><meta name=author content="Michael Bisbjerg"><link rel=canonical href=https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/><link crossorigin=anonymous href=/assets/css/stylesheet.36ab24e4c1b924360adfc391166b0e8914323d9d6ffa42a50f9c6c435c5e1831.css integrity="sha256-Nqsk5MG5JDYK38ORFmsOiRQyPZ1v+kKlD5xsQ1xeGDE=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.mbwarez.dk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.mbwarez.dk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.mbwarez.dk/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.mbwarez.dk/apple-touch-icon.png><link rel=mask-icon href=https://blog.mbwarez.dk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/"><meta property="og:site_name" content="Thoughts, stories and ideas"><meta property="og:title" content="Using dmsetup to Salvage Disks with Bad Blocks"><meta property="og:description" content="A guide to rescuing disks with bad blocks using dmsetup, avoiding the need for costly replacements."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-07T00:00:00+00:00"><meta property="article:modified_time" content="2025-04-07T00:00:00+00:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Storage"><meta property="article:tag" content="Dmsetup"><meta property="article:tag" content="Zfs"><meta property="article:tag" content="Badblocks"><meta property="og:image" content="https://blog.mbwarez.dk/assets/images/cover.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.mbwarez.dk/assets/images/cover.jpg"><meta name=twitter:title content="Using dmsetup to Salvage Disks with Bad Blocks"><meta name=twitter:description content="A guide to rescuing disks with bad blocks using dmsetup, avoiding the need for costly replacements."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.mbwarez.dk/posts/"},{"@type":"ListItem","position":2,"name":"Using dmsetup to Salvage Disks with Bad Blocks","item":"https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using dmsetup to Salvage Disks with Bad Blocks","name":"Using dmsetup to Salvage Disks with Bad Blocks","description":"A guide to rescuing disks with bad blocks using dmsetup, avoiding the need for costly replacements.","keywords":["linux","storage","dmsetup","zfs","badblocks"],"articleBody":"Introduction I have a disk with bad blocks. The filesystem I’m using (such as ZFS) doesn’t support marking bad blocks like ext did, and completely replacing the disk is costly and unnecessary. Instead, I’ve used dmsetup to create a virtual disk that excludes the bad sectors, allowing the filesystem to work with the remaining good areas.\nThis guide covers the process of scanning the disk, preparing a custom partition, setting up dmsetup, and ensuring everything works across reboots. I’ve additionally included steps to ensure that the dmsetup configuration follows the disk, ensuring you don’t loose that critical piece of information.\nEssential components Device mapper is a linux component that allows us to create virtual devices, who’s underlying implementation can change. This can be used to implement striping, multipathing, redirect parts of the device to different physical disks, various tests like artificial delays and errors and so on. In this post, I use it to map around bad blocks. The process The process will:\nCreate a partition layout on the faulty disk Run badblocks to identify faulty areas Create the necessary dmsetup configuration “Mount” the virtual device, and ensure it mounts on boot 1. Creating Partitions We will first prepare a partition to hold the configuration for dmsetup.\nparted /dev/ mklabel gpt parted /dev/ mkpart primary ext3 1MB 20MB parted /dev/ mkpart primary 20MB 100% # Make the configuration partition use ext3, a widely supported filesystem mkfs.ext3 /dev/1 e2label /dev/1 \"READ ME\" This creates two partitions:\nPartition 1: A very small partition to hold important configurations on this disk Partition 2: The remainder of the drive. This is where we will be making our dmsetup magic I made the small partition 20MB, but even that may be too large. Although its more tricky to make it larger if needed, later on.\nℹ️ Info: The ext3 partition holds the configuration files (dmsetup table, systemd service) so that everything follows the disk when you move it around. Setting its label to ‘READ ME’ hints at its purpose and ensures anyone inspecting the disk understands its role.\n2. Running Badblocks Scan the remainder of the disk for bad blocks:\nbadblocks -b 512 -o badblocks.txt -s Now, you can additionally:\nRun badblocks with -n for a non-destructive read-write mode, it rewrites the entire disk with the same contents Run badblocks with -w for a destructive read-write mode, it overwrites the entire disk with 4 patterns If you do this, also consider passing -p 1 to just do one pass. My disks are 8 TB, 4 passes is a lot ℹ️ Info: Even if the physical disk uses 4k sectors, we use 512-byte sectors, as dmsetup operates on 512-byte units.\n3. Identify good ranges Once badblocks is done, you’ll have a file filled with sectors that are considered bad. Now, we need to inverse that to get ranges that are good. You can do this manually, read the file and identify sequential sets of numbers, then write out the ranges between those numbers. F.ex, a file with the numbers 1, 2, 3, 9, 10, 17 should give ranges 0-1, 4-9, 11-17. I’ve also prepared a bash script that can do this:\ngenerate_dmsetup_table() { local device=\"$1\" local badblocks_file=\"$2\" if [[ ! -b \"$device\" ]]; then echo \"Device not found or not a block device: $device\" \u003e\u00262 return 1 fi if [[ ! -f \"$badblocks_file\" ]]; then echo \"Badblocks file not found: $badblocks_file\" \u003e\u00262 return 1 fi # Get the total number of 512-byte sectors on the device local total_sectors total_sectors=$(blockdev --getsz \"$device\") if [[ -z \"$total_sectors\" ]]; then echo \"Failed to retrieve the total number of sectors from $device.\" \u003e\u00262 return 1 fi # Read numbers into an array readarray -t numbers \u003c \"$badblocks_file\" local prev=-1 local offset=0 # Add initial good range from 0 to the first bad block (if not starting at 0) if (( numbers[0] \u003e 0 )); then local length=$((numbers[0] - 0)) echo \"0 $length $device linear $offset\" offset=$((offset + length)) fi # Iterate over the bad blocks to generate ranges for i in \"${!numbers[@]}\"; do local num=\"${numbers[i]}\" if (( prev != -1 \u0026\u0026 num \u003e prev + 1 )); then local start=$((prev + 1)) local length=$((num - start)) echo \"$start $length $device linear $offset\" offset=$((offset + length)) fi prev=$num done # Add final range from the last bad block to the end of the device if (( prev \u003c total_sectors - 1 )); then local start=$((prev + 1)) local length=$((total_sectors - start)) echo \"$start $length $device linear $offset\" fi } # Example use: \u003e generate_dmsetup_table /dev/2 badblocks.txt This script should ideally generate a dmsetup table, which covers the good ranges in the badblocks file.\n⚠️ Important: Make sure to reference the second partition of your disk, the one that covers the rest of the disk. All offsets are relative to that device. If you don’t, the final dmsetup device will be incorrect.\nℹ️ Info: At this point, begin referencing the disk by its id, like /dev/disk/by-id/-part2. This reference persists between reboots, and will make sure your dmsetup file also references that.\nOnce ready, output the table to a file in /etc/dmsetup, f.ex. /etc/dmsetup/sd-badblocks-.table.\n4. Setting up dmsetup systemd unit Create this systemd unit, in /etc/systemd/system/dmsetup-sd-badblocks-.service\n[Unit] Description=Prepare dmsetup device for , to avoid badblocks [Service] Type=oneshot ExecStart=/bin/sh -c '/bin/cat /etc/dmsetup/.table | /sbin/dmsetup create sd-badblocks-' ExecStop=/sbin/dmsetup remove RemainAfterExit=true [Install] WantedBy=multi-user.target ℹ️ Info: If, like me, you’re using ZFS, it is important that this unit loads before ZFS mounts its devices. Add this line under the [Unit] section to ensure ZFS mounts after: Before=zfs-mount.service\nReload the unit, and start it. Verify it doesn’t emit any errors.\nsystemctl daemon-reload systemctl start dmsetup-sd-badblocks- Once it works, enable the service to make it auto-start on boot\nsystemctl enable dmsetup-sd-badblocks- ℹ️ Info: We copy the table into /etc/dmsetup to ensure that on boot, we don’t need to first have the configuration mounted and then be able to load dmsetup. It’s better to have fewer dependencies. Step 6 below will copy in the configuration to the first partition for safekeeping, but once thats done, you don’t need to mount that partition again (until you move the disk or reinstall the OS of course).\n6. Preparing the configuration partition Copy the table, and the systemd unit to your configuration partition.\nmkdir /mnt/tmp mount /dev/1 /mnt/tmp cp /etc/dmsetup/.table /mnt/tmp/ cp /etc/systemd/system/dmsetup-sd-badblocks-.service /mnt/tmp/ # Copy this blogpost to the readme printf \"Source: https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/\\n\\n\" \u003e /mnt/tmp/README.txt wget https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/readme.txt -O - \u003e\u003e /mnt/tmp/README.txt ℹ️ Info: Now, if you move the disk to a new computer or similarly, then mounting the first partition will show the information needed to mount the second partition using dmsetup.\nFuture improvements If someone revisits this, future ideas could be:\nImportant: It is possible to mount (⚠️) the second partition, as it will contain actual filesystem headers. One fix, is to reorder the first few sectors of any device mapped disk, making the partition unreadable as a filesystem. The systemd unit could be made into a template unit, allowing it to simply be enabled for each @disk-id, streamlining the process. Summary By using this method, you can salvage a disk with bad sectors and make it usable again without having to replace it. This approach is especially useful when working with filesystems that do not support marking bad blocks, like ZFS.\nYou can replicate this process for other disks by adjusting the disk IDs and table filenames.\n","wordCount":"1228","inLanguage":"en","image":"https://blog.mbwarez.dk/assets/images/cover.jpg","datePublished":"2025-04-07T00:00:00Z","dateModified":"2025-04-07T00:00:00Z","author":{"@type":"Person","name":"Michael Bisbjerg"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/"},"publisher":{"@type":"Organization","name":"Thoughts, stories and ideas","logo":{"@type":"ImageObject","url":"https://blog.mbwarez.dk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.mbwarez.dk/ accesskey=h title="Thoughts, stories and ideas (Alt + H)">Thoughts, stories and ideas</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.mbwarez.dk/archives title="All posts"><span>All posts</span></a></li><li><a href=https://blog.mbwarez.dk/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.mbwarez.dk/tags title=Tags><span>Tags</span></a></li><li><a href=https://github.com/LordMike/ title=Github><span>Github</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.linkedin.com/in/michael-bisbjerg/ title=LinkedIn><span>LinkedIn</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.mbwarez.dk/>Home</a>&nbsp;»&nbsp;<a href=https://blog.mbwarez.dk/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Using dmsetup to Salvage Disks with Bad Blocks</h1><div class=post-description>A guide to rescuing disks with bad blocks using dmsetup, avoiding the need for costly replacements.</div><div class=post-meta><span title='2025-04-07 00:00:00 +0000 UTC'>April 7, 2025</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Michael Bisbjerg</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#introduction aria-label=Introduction>Introduction</a><ul><li><a href=#essential-components aria-label="Essential components">Essential components</a></li></ul></li><li><a href=#the-process aria-label="The process">The process</a><ul><li><a href=#1-creating-partitions aria-label="1. Creating Partitions">1. Creating Partitions</a></li><li><a href=#2-running-badblocks aria-label="2. Running Badblocks">2. Running Badblocks</a></li><li><a href=#3-identify-good-ranges aria-label="3. Identify good ranges">3. Identify good ranges</a></li><li><a href=#4-setting-up-dmsetup-systemd-unit aria-label="4. Setting up dmsetup systemd unit">4. Setting up dmsetup systemd unit</a></li><li><a href=#6-preparing-the-configuration-partition aria-label="6. Preparing the configuration partition">6. Preparing the configuration partition</a></li><li><a href=#future-improvements aria-label="Future improvements">Future improvements</a></li><li><a href=#summary aria-label=Summary>Summary</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h1><p>I have a disk with bad blocks. The filesystem I&rsquo;m using (such as ZFS) doesn&rsquo;t support marking bad blocks like ext did, and completely replacing the disk is costly and unnecessary. Instead, I&rsquo;ve used <code>dmsetup</code> to create a virtual disk that excludes the bad sectors, allowing the filesystem to work with the remaining good areas.</p><p>This guide covers the process of scanning the disk, preparing a custom partition, setting up <code>dmsetup</code>, and ensuring everything works across reboots. I&rsquo;ve additionally included steps to ensure that the <code>dmsetup</code> configuration follows the disk, ensuring you don&rsquo;t loose that critical piece of information.</p><h2 id=essential-components>Essential components<a hidden class=anchor aria-hidden=true href=#essential-components>#</a></h2><ul><li><strong>Device mapper</strong> is a linux component that allows us to create virtual devices, who&rsquo;s underlying implementation can change. This can be used to implement striping, multipathing, redirect parts of the device to different physical disks, various tests like artificial delays and errors and so on. In this post, I use it to map around bad blocks.</li></ul><h1 id=the-process>The process<a hidden class=anchor aria-hidden=true href=#the-process>#</a></h1><p>The process will:</p><ol><li>Create a partition layout on the faulty disk</li><li>Run <code>badblocks</code> to identify faulty areas</li><li>Create the necessary <code>dmsetup</code> configuration</li><li>&ldquo;Mount&rdquo; the virtual device, and ensure it mounts on boot</li></ol><h2 id=1-creating-partitions>1. Creating Partitions<a hidden class=anchor aria-hidden=true href=#1-creating-partitions>#</a></h2><p>We will first prepare a partition to hold the configuration for <code>dmsetup</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>parted /dev/&lt;disk&gt; mklabel gpt
</span></span><span class=line><span class=cl>parted /dev/&lt;disk&gt; mkpart primary ext3 1MB 20MB
</span></span><span class=line><span class=cl>parted /dev/&lt;disk&gt; mkpart primary 20MB 100%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Make the configuration partition use ext3, a widely supported filesystem</span>
</span></span><span class=line><span class=cl>mkfs.ext3 /dev/&lt;disk&gt;1
</span></span><span class=line><span class=cl>e2label /dev/&lt;disk&gt;1 <span class=s2>&#34;READ ME&#34;</span>
</span></span></code></pre></div><p>This creates two partitions:</p><ul><li>Partition 1: A very small partition to hold important configurations on this disk</li><li>Partition 2: The remainder of the drive. This is where we will be making our <code>dmsetup</code> magic</li></ul><p>I made the small partition 20MB, but even that may be too large. Although its more tricky to make it larger if needed, later on.</p><blockquote><p>ℹ️ Info: The ext3 partition holds the configuration files (<code>dmsetup</code> table, systemd service) so that everything follows the disk when you move it around. Setting its label to <strong>&lsquo;READ ME&rsquo;</strong> hints at its purpose and ensures anyone inspecting the disk understands its role.</p></blockquote><h2 id=2-running-badblocks>2. Running Badblocks<a hidden class=anchor aria-hidden=true href=#2-running-badblocks>#</a></h2><p>Scan the remainder of the disk for bad blocks:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>badblocks -b <span class=m>512</span> -o badblocks.txt -s
</span></span></code></pre></div><p>Now, you can additionally:</p><ul><li>Run <code>badblocks</code> with <code>-n</code> for a non-destructive read-write mode, it rewrites the entire disk with the same contents</li><li>Run <code>badblocks</code> with <code>-w</code> for a <strong>destructive</strong> read-write mode, it overwrites the entire disk with 4 patterns<ul><li>If you do this, also consider passing <code>-p 1</code> to just do one pass. My disks are 8 TB, 4 passes is a lot</li></ul></li></ul><blockquote><p>ℹ️ Info: Even if the physical disk uses 4k sectors, we use 512-byte sectors, as <code>dmsetup</code> operates on 512-byte units.</p></blockquote><h2 id=3-identify-good-ranges>3. Identify good ranges<a hidden class=anchor aria-hidden=true href=#3-identify-good-ranges>#</a></h2><p>Once <code>badblocks</code> is done, you&rsquo;ll have a file filled with sectors that are considered bad. Now, we need to <em>inverse</em> that to get ranges that are good. You can do this manually, read the file and identify sequential sets of numbers, then write out the ranges <em>between</em> those numbers. F.ex, a file with the numbers <code>1, 2, 3, 9, 10, 17</code> should give ranges <code>0-1, 4-9, 11-17</code>. I&rsquo;ve also prepared a bash script that can do this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>generate_dmsetup_table<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>device</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>badblocks_file</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> ! -b <span class=s2>&#34;</span><span class=nv>$device</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Device not found or not a block device: </span><span class=nv>$device</span><span class=s2>&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> ! -f <span class=s2>&#34;</span><span class=nv>$badblocks_file</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Badblocks file not found: </span><span class=nv>$badblocks_file</span><span class=s2>&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Get the total number of 512-byte sectors on the device</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> total_sectors
</span></span><span class=line><span class=cl>    <span class=nv>total_sectors</span><span class=o>=</span><span class=k>$(</span>blockdev --getsz <span class=s2>&#34;</span><span class=nv>$device</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$total_sectors</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Failed to retrieve the total number of sectors from </span><span class=nv>$device</span><span class=s2>.&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Read numbers into an array</span>
</span></span><span class=line><span class=cl>    readarray -t numbers &lt; <span class=s2>&#34;</span><span class=nv>$badblocks_file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>prev</span><span class=o>=</span>-1
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>offset</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Add initial good range from 0 to the first bad block (if not starting at 0)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>((</span> numbers<span class=o>[</span>0<span class=o>]</span> &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>length</span><span class=o>=</span><span class=k>$((</span>numbers<span class=o>[</span><span class=m>0</span><span class=o>]</span> <span class=o>-</span> <span class=m>0</span><span class=k>))</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;0 </span><span class=nv>$length</span><span class=s2> </span><span class=nv>$device</span><span class=s2> linear </span><span class=nv>$offset</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nv>offset</span><span class=o>=</span><span class=k>$((</span>offset <span class=o>+</span> length<span class=k>))</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Iterate over the bad blocks to generate ranges</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> i in <span class=s2>&#34;</span><span class=si>${</span><span class=p>!numbers[@]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>num</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>numbers</span><span class=p>[i]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>((</span> prev !<span class=o>=</span> -1 <span class=o>&amp;&amp;</span> num &gt; prev + <span class=m>1</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nb>local</span> <span class=nv>start</span><span class=o>=</span><span class=k>$((</span>prev <span class=o>+</span> <span class=m>1</span><span class=k>))</span>
</span></span><span class=line><span class=cl>            <span class=nb>local</span> <span class=nv>length</span><span class=o>=</span><span class=k>$((</span>num <span class=o>-</span> start<span class=k>))</span>
</span></span><span class=line><span class=cl>            <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$start</span><span class=s2> </span><span class=nv>$length</span><span class=s2> </span><span class=nv>$device</span><span class=s2> linear </span><span class=nv>$offset</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nv>offset</span><span class=o>=</span><span class=k>$((</span>offset <span class=o>+</span> length<span class=k>))</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=nv>prev</span><span class=o>=</span><span class=nv>$num</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Add final range from the last bad block to the end of the device</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>((</span> prev &lt; total_sectors - <span class=m>1</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>start</span><span class=o>=</span><span class=k>$((</span>prev <span class=o>+</span> <span class=m>1</span><span class=k>))</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>length</span><span class=o>=</span><span class=k>$((</span>total_sectors <span class=o>-</span> start<span class=k>))</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$start</span><span class=s2> </span><span class=nv>$length</span><span class=s2> </span><span class=nv>$device</span><span class=s2> linear </span><span class=nv>$offset</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Example use:</span>
</span></span><span class=line><span class=cl>&gt; generate_dmsetup_table /dev/&lt;disk&gt;2 badblocks.txt
</span></span></code></pre></div><p>This script should ideally generate a dmsetup table, which covers the good ranges in the badblocks file.</p><blockquote><p>⚠️ Important: Make sure to reference the second partition of your disk, the one that covers the rest of the disk. All offsets are <em>relative</em> to that device. If you don&rsquo;t, the final dmsetup device will be incorrect.</p></blockquote><blockquote><p>ℹ️ Info: At this point, begin referencing the disk by its id, like <code>/dev/disk/by-id/&lt;disk>-part2</code>. This reference persists between reboots, and will make sure your dmsetup file also references that.</p></blockquote><p>Once ready, output the table to a file in <code>/etc/dmsetup</code>, f.ex. <code>/etc/dmsetup/sd-badblocks-&lt;disk>.table</code>.</p><h2 id=4-setting-up-dmsetup-systemd-unit>4. Setting up <code>dmsetup</code> systemd unit<a hidden class=anchor aria-hidden=true href=#4-setting-up-dmsetup-systemd-unit>#</a></h2><p>Create this <code>systemd</code> unit, in <code>/etc/systemd/system/dmsetup-sd-badblocks-&lt;disk>.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Unit]</span>
</span></span><span class=line><span class=cl><span class=na>Description</span><span class=o>=</span><span class=s>Prepare dmsetup device for &lt;device&gt;, to avoid badblocks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Service]</span>
</span></span><span class=line><span class=cl><span class=na>Type</span><span class=o>=</span><span class=s>oneshot</span>
</span></span><span class=line><span class=cl><span class=na>ExecStart</span><span class=o>=</span><span class=s>/bin/sh -c &#39;/bin/cat /etc/dmsetup/&lt;disk-id&gt;.table | /sbin/dmsetup create sd-badblocks-&lt;disk-id&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=na>ExecStop</span><span class=o>=</span><span class=s>/sbin/dmsetup remove &lt;disk-id&gt;</span>
</span></span><span class=line><span class=cl><span class=na>RemainAfterExit</span><span class=o>=</span><span class=s>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Install]</span>
</span></span><span class=line><span class=cl><span class=na>WantedBy</span><span class=o>=</span><span class=s>multi-user.target</span>
</span></span></code></pre></div><blockquote><p>ℹ️ Info: If, like me, you&rsquo;re using ZFS, it is important that this unit loads <em>before</em> ZFS mounts its devices. Add this line under the <code>[Unit]</code> section to ensure ZFS mounts <em>after</em>: <code>Before=zfs-mount.service</code></p></blockquote><p>Reload the unit, and start it. Verify it doesn&rsquo;t emit any errors.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl start dmsetup-sd-badblocks-&lt;disk&gt;
</span></span></code></pre></div><p>Once it works, enable the service to make it auto-start on boot</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl <span class=nb>enable</span> dmsetup-sd-badblocks-&lt;disk&gt;
</span></span></code></pre></div><blockquote><p>ℹ️ Info: We copy the table into <code>/etc/dmsetup</code> to ensure that on boot, we don&rsquo;t need to <em>first</em> have the configuration mounted and <em>then</em> be able to load <code>dmsetup</code>. It&rsquo;s better to have fewer dependencies. Step 6 below will copy in the configuration to the first partition for safekeeping, but once thats done, you don&rsquo;t need to mount that partition again (until you move the disk or reinstall the OS of course).</p></blockquote><h2 id=6-preparing-the-configuration-partition>6. Preparing the configuration partition<a hidden class=anchor aria-hidden=true href=#6-preparing-the-configuration-partition>#</a></h2><p>Copy the table, and the systemd unit to your configuration partition.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir /mnt/tmp
</span></span><span class=line><span class=cl>mount /dev/&lt;disk&gt;1 /mnt/tmp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /etc/dmsetup/&lt;disk-id&gt;.table /mnt/tmp/
</span></span><span class=line><span class=cl>cp /etc/systemd/system/dmsetup-sd-badblocks-&lt;disk&gt;.service /mnt/tmp/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Copy this blogpost to the readme</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s2>&#34;Source: https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/\n\n&#34;</span> &gt; /mnt/tmp/README.txt
</span></span><span class=line><span class=cl>wget https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/readme.txt -O - &gt;&gt; /mnt/tmp/README.txt
</span></span></code></pre></div><blockquote><p>ℹ️ Info: Now, if you move the disk to a new computer or similarly, then mounting the first partition will show the information needed to mount the second partition using dmsetup.</p></blockquote><h2 id=future-improvements>Future improvements<a hidden class=anchor aria-hidden=true href=#future-improvements>#</a></h2><p>If someone revisits this, future ideas could be:</p><ul><li><strong>Important:</strong> It is possible to mount (⚠️) the second partition, as it will contain actual filesystem headers. One fix, is to reorder the first few sectors of any device mapped disk, making the partition unreadable as a filesystem.</li><li>The systemd unit could be made into a <a href=https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html#Service%20Templates>template unit</a>, allowing it to simply be enabled for each <code>@disk-id</code>, streamlining the process.</li></ul><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2><p>By using this method, you can salvage a disk with bad sectors and make it usable again without having to replace it. This approach is especially useful when working with filesystems that do not support marking bad blocks, like ZFS.</p><p>You can replicate this process for other disks by adjusting the disk IDs and table filenames.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.mbwarez.dk/tags/linux/>Linux</a></li><li><a href=https://blog.mbwarez.dk/tags/storage/>Storage</a></li><li><a href=https://blog.mbwarez.dk/tags/dmsetup/>Dmsetup</a></li><li><a href=https://blog.mbwarez.dk/tags/zfs/>Zfs</a></li><li><a href=https://blog.mbwarez.dk/tags/badblocks/>Badblocks</a></li></ul><nav class=paginav><a class=next href=https://blog.mbwarez.dk/posts/2025/03/wled-backup-script/><span class=title>Next »</span><br><span>WLED Backup script</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on x" href="https://x.com/intent/tweet/?text=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks&amp;url=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f&amp;hashtags=linux%2cstorage%2cdmsetup%2czfs%2cbadblocks"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f&amp;title=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks&amp;summary=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks&amp;source=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f&title=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on whatsapp" href="https://api.whatsapp.com/send?text=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks%20-%20https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on telegram" href="https://telegram.me/share/url?text=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks&amp;url=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on ycombinator" href="https://news.ycombinator.com/submitlink?t=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks&u=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>© <a href=https://github.com/LordMike>Michael Bisbjerg</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>
<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using dmsetup to Salvage Disks with Bad Blocks | Thoughts, stories and ideas</title>
<meta name=keywords content="linux,storage,dmsetup,zfs,badblocks"><meta name=description content="A guide to rescuing disks with bad blocks using dmsetup, avoiding the need for costly replacements."><meta name=author content="Michael Bisbjerg"><link rel=canonical href=https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/><link crossorigin=anonymous href=/assets/css/stylesheet.36ab24e4c1b924360adfc391166b0e8914323d9d6ffa42a50f9c6c435c5e1831.css integrity="sha256-Nqsk5MG5JDYK38ORFmsOiRQyPZ1v+kKlD5xsQ1xeGDE=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.mbwarez.dk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.mbwarez.dk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.mbwarez.dk/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.mbwarez.dk/apple-touch-icon.png><link rel=mask-icon href=https://blog.mbwarez.dk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/"><meta property="og:site_name" content="Thoughts, stories and ideas"><meta property="og:title" content="Using dmsetup to Salvage Disks with Bad Blocks"><meta property="og:description" content="A guide to rescuing disks with bad blocks using dmsetup, avoiding the need for costly replacements."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-07T00:00:00+00:00"><meta property="article:modified_time" content="2025-04-07T00:00:00+00:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Storage"><meta property="article:tag" content="Dmsetup"><meta property="article:tag" content="Zfs"><meta property="article:tag" content="Badblocks"><meta property="og:image" content="https://blog.mbwarez.dk/assets/images/cover.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.mbwarez.dk/assets/images/cover.jpg"><meta name=twitter:title content="Using dmsetup to Salvage Disks with Bad Blocks"><meta name=twitter:description content="A guide to rescuing disks with bad blocks using dmsetup, avoiding the need for costly replacements."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.mbwarez.dk/posts/"},{"@type":"ListItem","position":2,"name":"Using dmsetup to Salvage Disks with Bad Blocks","item":"https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using dmsetup to Salvage Disks with Bad Blocks","name":"Using dmsetup to Salvage Disks with Bad Blocks","description":"A guide to rescuing disks with bad blocks using dmsetup, avoiding the need for costly replacements.","keywords":["linux","storage","dmsetup","zfs","badblocks"],"articleBody":"Introduction I have a disk with bad blocks. The filesystem I’m using (such as ZFS) doesn’t support marking bad blocks like ext did, and completely replacing the disk is costly and unnecessary. Instead, I’ve used dmsetup to create a virtual disk that excludes the bad sectors, allowing the filesystem to work with the remaining good areas.\nThis guide covers the process of scanning the disk, preparing a custom partition, setting up dmsetup, and ensuring everything works across reboots. I’ve additionally included steps to ensure that the dmsetup configuration follows the disk, ensuring you don’t loose that critical piece of information.\nℹ️ Info: If you’re mounting a disk that was prepared by this post, skip to step 4 and copy files from the ext3 filesystem in partition 1.\nEssential components Device mapper is a linux component that allows us to create virtual devices, who’s underlying implementation can change. This can be used to implement striping, multipathing, redirect parts of the device to different physical disks, various tests like artificial delays and errors and so on. In this post, I use it to map around bad blocks. Identifying disks by their id - to ensure that we never encounter issues due to disk renumbering, or when moving between systems, it is essential to use the disk ids instead of their temporary names. All disks should be available in /dev/disk/by-id/ on your linux system. My approach will use the disk id, like scsi-88774aaeef234 as the identifier for the device. ℹ️ Info: You can replace DISK_ID in all the following text by putting it here: The process The process will:\nCreate a partition layout on the faulty disk Run badblocks to identify faulty areas Create the necessary dmsetup configuration and systemd unit “Mount” the virtual device, and ensure it mounts on boot 0. Identify the disk Say you want to operate on /dev/sdk. Identify its id, by looking in /dev/disk/by-id/, like this:\nfind /dev/disk/by-id -lname \"*sdk\" This above script will list all the links in by-id that point to sdk. Choose your preferred id, and substitue the DISK_ID in all future bits of this post with the name of that. As an example, you may choose /dev/disk/by-id/scsi-35000039fe6e8235c - then use scsi-35000039fe6e8235c.\n1. Creating Partitions We will first prepare a partition layout to separate the configuration for dmsetup and the remainder of the disk.\nparted /dev/disk/by-id/DISK_ID mklabel gpt parted /dev/disk/by-id/DISK_ID mkpart primary ext3 1MB 10MB parted /dev/disk/by-id/DISK_ID mkpart primary 10MB 100% This creates two partitions:\nPartition 1: A very small partition to hold important configurations on this disk Partition 2: The remainder of the drive. This is where we will be making our dmsetup magic I made the small partition 10MB, but even that may be too large. Although its more tricky to make it larger if needed, later on.\n2. Running Badblocks Scan the remainder of the disk for bad blocks:\nbadblocks -b 4096 -o badblocks-4k.txt -s /dev/disk/by-id/DISK_ID-part2 Now, you can additionally:\nAdd -n for a non-destructive read-write mode, it rewrites the entire disk with the same contents Add -w for a destructive read-write mode, it overwrites the entire disk with 4 patterns Remove -s (status reporting) if you, like me, are running this in parallel on many disks. ⚠️ Important: -w is destructive, it will overwrite data.\nℹ️ Info: dmsetup operates on 512-byte units, so ideally we would set -b 512 to keep everything aligned, but badblocks uses 32-bit integers internally for blocks. So 512-byte blocks has a cap of a 2TB disk, 1024-byte a 4 TB disk and so on. I will operate on 4096 byte blocks, because most larger disks are this size anyways, but we’ll have to multiply all offsets later on to compensate.\nℹ️ Info: If we ever need to in the future, we must run badblocks with the same block size as before. I’ve encoded the size in the filename (-4k.txt) so we can know.\n3. Prepare dmsetup and systemd Once badblocks is done, you’ll have a file filled with blocks that are considered bad. Now, we need to inverse that to get ranges that are good. You can do this manually, read the file and identify sequential sets of numbers, then write out the ranges between those numbers. F.ex, a file with the numbers 1, 2, 3, 9, 10, 17 should give ranges 0-1, 4-9, 11-17.\nI’ve prepared a bash script that can:\nPrepare a dmsetup table for the disk with the inverse of the badblocks ranges Prepare a systemd unit that can load our dmsetup device Bash script to prepare dmsetup and system configs generate_dmsetup_and_systemd_unit() { local input=\"$1\" local badblocks_file=\"$2\" local block_size=\"$3\" # Resolve input to a /dev/disk/by-id/ path (disk, not partition) local device=\"\" if [[ \"$input\" =~ ^/dev/disk/by-id/ ]]; then device=\"$input\" elif [[ \"$input\" =~ ^/dev/ ]]; then device=$(find /dev/disk/by-id -lname \"*${input##*/}\" | grep -E '/dev/disk/by-id/(scsi|ata|nvme|sas)-[0-9a-fA-F]+' | head -n1) if [[ -z \"$device\" ]]; then device=$(find /dev/disk/by-id -lname \"*${input##*/}\" | grep -E '/dev/disk/by-id/wwn-' | head -n1) fi if [[ -z \"$device\" ]]; then device=$(find /dev/disk/by-id -lname \"*${input##*/}\" | head -n1) fi else device=\"/dev/disk/by-id/$input\" fi if [[ ! -e \"$device\" || ! -b \"$device\" ]]; then echo \"Error: Unable to resolve '$input' to a valid /dev/disk/by-id/ block device.\" \u003e\u00262 return 1 fi local id=\"${device##*/}\" local part_device=\"${device}-part2\" if [[ ! -e \"$part_device\" || ! -b \"$part_device\" ]]; then echo \"Error: Expected partition device $part_device not found.\" \u003e\u00262 return 1 fi local name=\"dm-badblocks-${id}\" local table_file=\"${name}.table\" local service_file=\"${name}.service\" if [[ ! -f \"$badblocks_file\" ]]; then echo \"Error: badblocks file not found: $badblocks_file\" \u003e\u00262 return 1 fi if [[ -z \"$block_size\" || \"$block_size\" -lt 512 ]]; then echo \"Error: block size must be \u003e= 512\" \u003e\u00262 return 1 fi if (( block_size \u0026 (block_size - 1) )); then echo \"Error: block size must be a power of 2\" \u003e\u00262 return 1 fi local scale=$((block_size / 512)) local total_sectors total_sectors=$(blockdev --getsz \"$part_device\") echo \"Generating ${table_file} for $part_device...\" # Parse/sort badblocks file (may be empty) local -a badblock_sectors while IFS= read -r line; do [[ -n \"$line\" ]] \u0026\u0026 badblock_sectors+=($((line * scale))) done \u003c \u003c(sort -n \"$badblocks_file\") # Emit a dmsetup table file in the form \" linear \" if (( ${#badblock_sectors[@]} == 0 )); then { local length=$((total_sectors - 8)) echo \"0 $length linear $part_device 8\" } \u003e \"$table_file\" else if (( badblock_sectors[0] \u003c= 8 )); then echo \"Error: there are badblocks on the first sectors of the disk. This is not supported by this script.\" \u003e\u00262 return 1 fi { local first_length=$((badblock_sectors[0] - 8)) echo \"0 $first_length linear $part_device 8\" local offset=$((first_length)) local physical_sector_prev=-1 for i in \"${!badblock_sectors[@]}\"; do local physical_sector=\"${badblock_sectors[i]}\" if (( physical_sector_prev != -1 \u0026\u0026 physical_sector \u003e physical_sector_prev + 1 )); then local start=$((physical_sector_prev + 1)) local length=$((physical_sector - start)) echo \"$offset $length linear $part_device $start\" offset=$((offset + length)) fi physical_sector_prev=$physical_sector done # Final range if (( physical_sector_prev \u003c total_sectors - 1 )); then local start=$((physical_sector_prev + 1)) local length=$((total_sectors - start)) echo \"$offset $length linear $part_device $start\" fi } \u003e \"$table_file\" fi echo \"Generating ${service_file}...\" local encoded_id=\"${id//-/'\\\\x2d'}\" cat \u003e \"$service_file\" \u003c","wordCount":"1769","inLanguage":"en","image":"https://blog.mbwarez.dk/assets/images/cover.jpg","datePublished":"2025-04-07T00:00:00Z","dateModified":"2025-04-07T00:00:00Z","author":{"@type":"Person","name":"Michael Bisbjerg"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/"},"publisher":{"@type":"Organization","name":"Thoughts, stories and ideas","logo":{"@type":"ImageObject","url":"https://blog.mbwarez.dk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.mbwarez.dk/ accesskey=h title="Thoughts, stories and ideas (Alt + H)">Thoughts, stories and ideas</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.mbwarez.dk/archives title="All posts"><span>All posts</span></a></li><li><a href=https://blog.mbwarez.dk/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.mbwarez.dk/tags title=Tags><span>Tags</span></a></li><li><a href=https://github.com/LordMike/ title=Github><span>Github</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.linkedin.com/in/michael-bisbjerg/ title=LinkedIn><span>LinkedIn</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.mbwarez.dk/>Home</a>&nbsp;»&nbsp;<a href=https://blog.mbwarez.dk/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Using dmsetup to Salvage Disks with Bad Blocks</h1><div class=post-description>A guide to rescuing disks with bad blocks using dmsetup, avoiding the need for costly replacements.</div><div class=post-meta><span title='2025-04-07 00:00:00 +0000 UTC'>April 7, 2025</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Michael Bisbjerg</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#introduction aria-label=Introduction>Introduction</a><ul><li><a href=#essential-components aria-label="Essential components">Essential components</a></li><li><a href=#the-process aria-label="The process">The process</a></li><li><a href=#0-identify-the-disk aria-label="0. Identify the disk">0. Identify the disk</a></li><li><a href=#1-creating-partitions aria-label="1. Creating Partitions">1. Creating Partitions</a></li><li><a href=#2-running-badblocks aria-label="2. Running Badblocks">2. Running Badblocks</a></li><li><a href=#3-prepare-dmsetup-and-systemd aria-label="3. Prepare dmsetup and systemd">3. Prepare dmsetup and systemd</a></li><li><a href=#4-setting-up-this-system aria-label="4. Setting up this system">4. Setting up this system</a></li><li><a href=#5-preparing-the-configuration-partition aria-label="5. Preparing the configuration partition">5. Preparing the configuration partition</a></li><li><a href=#summary aria-label=Summary>Summary</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h1><p>I have a disk with bad blocks. The filesystem I&rsquo;m using (such as ZFS) doesn&rsquo;t support marking bad blocks like ext did, and completely replacing the disk is costly and unnecessary. Instead, I&rsquo;ve used <code>dmsetup</code> to create a virtual disk that excludes the bad sectors, allowing the filesystem to work with the remaining good areas.</p><p>This guide covers the process of scanning the disk, preparing a custom partition, setting up <code>dmsetup</code>, and ensuring everything works across reboots. I&rsquo;ve additionally included steps to ensure that the <code>dmsetup</code> configuration follows the disk, ensuring you don&rsquo;t loose that critical piece of information.</p><blockquote><p>ℹ️ Info: If you&rsquo;re mounting a disk that was prepared by this post, skip to step 4 and copy files from the ext3 filesystem in partition 1.</p></blockquote><h2 id=essential-components>Essential components<a hidden class=anchor aria-hidden=true href=#essential-components>#</a></h2><ul><li><strong>Device mapper</strong> is a linux component that allows us to create virtual devices, who&rsquo;s underlying implementation can change. This can be used to implement striping, multipathing, redirect parts of the device to different physical disks, various tests like artificial delays and errors and so on. In this post, I use it to map around bad blocks.</li><li>Identifying disks <strong>by their id</strong> - to ensure that we never encounter issues due to disk renumbering, or when moving between systems, it is essential to use the disk ids instead of their temporary names. All disks should be available in <code>/dev/disk/by-id/</code> on your linux system. My approach will use the disk id, like <code>scsi-88774aaeef234</code> as the identifier for the device.</li></ul><blockquote>ℹ️ Info: You can replace <code>DISK_ID</code> in all the following text by putting it here:
<input type=text id=diskInput placeholder="My disk id" oninput=replaceDiskId()>
<script>function replaceDiskId(){const e=document.getElementById("diskInput").value;if(!e)return;if(anyReplaced=!1,document.querySelectorAll('span.disk-id[data-placeholder="DISK_ID"]').forEach(t=>{t.textContent=e,anyReplaced=!0}),anyReplaced)return;const s=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT),n=[];let t;for(;t=s.nextNode();)t.textContent.includes("DISK_ID")&&n.push(t);n.forEach(t=>{const o=t.textContent,i=t.parentNode,s=o.split("DISK_ID"),n=document.createDocumentFragment();s.forEach((t,o)=>{if(t&&n.appendChild(document.createTextNode(t)),o<s.length-1){const t=document.createElement("span");t.className="disk-id",t.dataset.placeholder="DISK_ID",t.textContent=e,n.appendChild(t)}}),i.replaceChild(n,t)})}</script><style>input{border:solid 1px #ccc;text-align:center}</style></blockquote><h2 id=the-process>The process<a hidden class=anchor aria-hidden=true href=#the-process>#</a></h2><p>The process will:</p><ol><li>Create a partition layout on the faulty disk</li><li>Run <code>badblocks</code> to identify faulty areas</li><li>Create the necessary <code>dmsetup</code> configuration and <code>systemd</code> unit</li><li>&ldquo;Mount&rdquo; the virtual device, and ensure it mounts on boot</li></ol><h2 id=0-identify-the-disk>0. Identify the disk<a hidden class=anchor aria-hidden=true href=#0-identify-the-disk>#</a></h2><p>Say you want to operate on <code>/dev/sdk</code>. Identify its id, by looking in <code>/dev/disk/by-id/</code>, like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>find /dev/disk/by-id -lname <span class=s2>&#34;*sdk&#34;</span>
</span></span></code></pre></div><p>This above script will list all the links in <code>by-id</code> that point to <code>sdk</code>. Choose your preferred id, and substitue the <code>DISK_ID</code> in all future bits of this post with the name of that. As an example, you may choose <code>/dev/disk/by-id/scsi-35000039fe6e8235c</code> - then use <code>scsi-35000039fe6e8235c</code>.</p><h2 id=1-creating-partitions>1. Creating Partitions<a hidden class=anchor aria-hidden=true href=#1-creating-partitions>#</a></h2><p>We will first prepare a partition layout to separate the configuration for <code>dmsetup</code> and the remainder of the disk.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>parted /dev/disk/by-id/DISK_ID mklabel gpt
</span></span><span class=line><span class=cl>parted /dev/disk/by-id/DISK_ID mkpart primary ext3 1MB 10MB
</span></span><span class=line><span class=cl>parted /dev/disk/by-id/DISK_ID mkpart primary 10MB 100%
</span></span></code></pre></div><p>This creates two partitions:</p><ul><li>Partition 1: A very small partition to hold important configurations on this disk</li><li>Partition 2: The remainder of the drive. This is where we will be making our <code>dmsetup</code> magic</li></ul><p>I made the small partition 10MB, but even that may be too large. Although its more tricky to make it larger if needed, later on.</p><h2 id=2-running-badblocks>2. Running Badblocks<a hidden class=anchor aria-hidden=true href=#2-running-badblocks>#</a></h2><p>Scan the remainder of the disk for bad blocks:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>badblocks -b <span class=m>4096</span> -o badblocks-4k.txt -s /dev/disk/by-id/DISK_ID-part2
</span></span></code></pre></div><p>Now, you can additionally:</p><ul><li>Add <code>-n</code> for a non-destructive read-write mode, it rewrites the entire disk with the same contents</li><li>Add <code>-w</code> for a <strong>destructive</strong> read-write mode, it overwrites the entire disk with 4 patterns</li><li>Remove <code>-s</code> (status reporting) if you, like me, are running this in parallel on many disks.</li></ul><blockquote><p>⚠️ Important: <code>-w</code> is destructive, it will overwrite data.</p></blockquote><blockquote><p>ℹ️ Info: <code>dmsetup</code> operates on 512-byte units, so ideally we would set <code>-b 512</code> to keep everything aligned, but badblocks uses 32-bit integers internally for blocks. So 512-byte blocks has a cap of a 2TB disk, 1024-byte a 4 TB disk and so on. I will operate on <code>4096</code> byte blocks, because most larger disks are this size anyways, but we&rsquo;ll have to multiply all offsets later on to compensate.</p></blockquote><blockquote><p>ℹ️ Info: If we ever need to in the future, we must run badblocks with the same block size as before. I&rsquo;ve encoded the size in the filename (<code>-4k.txt</code>) so we can know.</p></blockquote><h2 id=3-prepare-dmsetup-and-systemd>3. Prepare dmsetup and systemd<a hidden class=anchor aria-hidden=true href=#3-prepare-dmsetup-and-systemd>#</a></h2><p>Once <code>badblocks</code> is done, you&rsquo;ll have a file filled with blocks that are considered bad. Now, we need to <em>inverse</em> that to get ranges that are good. You can do this manually, read the file and identify sequential sets of numbers, then write out the ranges <em>between</em> those numbers. F.ex, a file with the numbers <code>1, 2, 3, 9, 10, 17</code> should give ranges <code>0-1, 4-9, 11-17</code>.</p><p>I&rsquo;ve prepared a bash script that can:</p><ul><li>Prepare a <code>dmsetup table</code> for the disk with the inverse of the badblocks ranges</li><li>Prepare a <code>systemd</code> unit that can load our <code>dmsetup</code> device</li></ul><p><details><summary markdown=span>Bash script to prepare dmsetup and system configs</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>generate_dmsetup_and_systemd_unit<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>input</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>badblocks_file</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>block_size</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$3</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Resolve input to a /dev/disk/by-id/ path (disk, not partition)</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>device</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> <span class=s2>&#34;</span><span class=nv>$input</span><span class=s2>&#34;</span> <span class=o>=</span>~ ^/dev/disk/by-id/ <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nv>device</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$input</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=o>[[</span> <span class=s2>&#34;</span><span class=nv>$input</span><span class=s2>&#34;</span> <span class=o>=</span>~ ^/dev/ <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nv>device</span><span class=o>=</span><span class=k>$(</span>find /dev/disk/by-id -lname <span class=s2>&#34;*</span><span class=si>${</span><span class=nv>input</span><span class=p>##*/</span><span class=si>}</span><span class=s2>&#34;</span> <span class=p>|</span> grep -E <span class=s1>&#39;/dev/disk/by-id/(scsi|ata|nvme|sas)-[0-9a-fA-F]+&#39;</span> <span class=p>|</span> head -n1<span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$device</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nv>device</span><span class=o>=</span><span class=k>$(</span>find /dev/disk/by-id -lname <span class=s2>&#34;*</span><span class=si>${</span><span class=nv>input</span><span class=p>##*/</span><span class=si>}</span><span class=s2>&#34;</span> <span class=p>|</span> grep -E <span class=s1>&#39;/dev/disk/by-id/wwn-&#39;</span> <span class=p>|</span> head -n1<span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$device</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nv>device</span><span class=o>=</span><span class=k>$(</span>find /dev/disk/by-id -lname <span class=s2>&#34;*</span><span class=si>${</span><span class=nv>input</span><span class=p>##*/</span><span class=si>}</span><span class=s2>&#34;</span> <span class=p>|</span> head -n1<span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nv>device</span><span class=o>=</span><span class=s2>&#34;/dev/disk/by-id/</span><span class=nv>$input</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> ! -e <span class=s2>&#34;</span><span class=nv>$device</span><span class=s2>&#34;</span> <span class=o>||</span> ! -b <span class=s2>&#34;</span><span class=nv>$device</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Error: Unable to resolve &#39;</span><span class=nv>$input</span><span class=s2>&#39; to a valid /dev/disk/by-id/ block device.&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>id</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>device</span><span class=p>##*/</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>part_device</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>device</span><span class=si>}</span><span class=s2>-part2&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> ! -e <span class=s2>&#34;</span><span class=nv>$part_device</span><span class=s2>&#34;</span> <span class=o>||</span> ! -b <span class=s2>&#34;</span><span class=nv>$part_device</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Error: Expected partition device </span><span class=nv>$part_device</span><span class=s2> not found.&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>name</span><span class=o>=</span><span class=s2>&#34;dm-badblocks-</span><span class=si>${</span><span class=nv>id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>table_file</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>name</span><span class=si>}</span><span class=s2>.table&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>service_file</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>name</span><span class=si>}</span><span class=s2>.service&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> ! -f <span class=s2>&#34;</span><span class=nv>$badblocks_file</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Error: badblocks file not found: </span><span class=nv>$badblocks_file</span><span class=s2>&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$block_size</span><span class=s2>&#34;</span> <span class=o>||</span> <span class=s2>&#34;</span><span class=nv>$block_size</span><span class=s2>&#34;</span> -lt <span class=m>512</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Error: block size must be &gt;= 512&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>((</span> block_size <span class=p>&amp;</span> <span class=o>(</span>block_size - 1<span class=o>)</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Error: block size must be a power of 2&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>scale</span><span class=o>=</span><span class=k>$((</span>block_size <span class=o>/</span> <span class=m>512</span><span class=k>))</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> total_sectors
</span></span><span class=line><span class=cl>    <span class=nv>total_sectors</span><span class=o>=</span><span class=k>$(</span>blockdev --getsz <span class=s2>&#34;</span><span class=nv>$part_device</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Generating </span><span class=si>${</span><span class=nv>table_file</span><span class=si>}</span><span class=s2> for </span><span class=nv>$part_device</span><span class=s2>...&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Parse/sort badblocks file (may be empty)</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> -a badblock_sectors
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nv>IFS</span><span class=o>=</span> <span class=nb>read</span> -r line<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=o>[[</span> -n <span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=nv>badblock_sectors</span><span class=o>+=(</span><span class=k>$((</span>line <span class=o>*</span> scale<span class=k>))</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span> &lt; &lt;<span class=o>(</span>sort -n <span class=s2>&#34;</span><span class=nv>$badblocks_file</span><span class=s2>&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Emit a dmsetup table file in the form &#34;&lt;virtual_offset&gt; &lt;length&gt; linear &lt;device&gt; &lt;physical_offset&gt;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>((</span> <span class=si>${#</span><span class=nv>badblock_sectors</span><span class=p>[@]</span><span class=si>}</span> <span class=o>==</span> <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>local</span> <span class=nv>length</span><span class=o>=</span><span class=k>$((</span>total_sectors <span class=o>-</span> <span class=m>8</span><span class=k>))</span>
</span></span><span class=line><span class=cl>            <span class=nb>echo</span> <span class=s2>&#34;0 </span><span class=nv>$length</span><span class=s2> linear </span><span class=nv>$part_device</span><span class=s2> 8&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> &gt; <span class=s2>&#34;</span><span class=nv>$table_file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>((</span> badblock_sectors<span class=o>[</span>0<span class=o>]</span> &lt;<span class=o>=</span> <span class=m>8</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nb>echo</span> <span class=s2>&#34;Error: there are badblocks on the first sectors of the disk. This is not supported by this script.&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>local</span> <span class=nv>first_length</span><span class=o>=</span><span class=k>$((</span>badblock_sectors<span class=o>[</span><span class=m>0</span><span class=o>]</span> <span class=o>-</span> <span class=m>8</span><span class=k>))</span>
</span></span><span class=line><span class=cl>            <span class=nb>echo</span> <span class=s2>&#34;0 </span><span class=nv>$first_length</span><span class=s2> linear </span><span class=nv>$part_device</span><span class=s2> 8&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nb>local</span> <span class=nv>offset</span><span class=o>=</span><span class=k>$((</span>first_length<span class=k>))</span>
</span></span><span class=line><span class=cl>            <span class=nb>local</span> <span class=nv>physical_sector_prev</span><span class=o>=</span>-1
</span></span><span class=line><span class=cl>            <span class=k>for</span> i in <span class=s2>&#34;</span><span class=si>${</span><span class=p>!badblock_sectors[@]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>                <span class=nb>local</span> <span class=nv>physical_sector</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>badblock_sectors</span><span class=p>[i]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>((</span> physical_sector_prev !<span class=o>=</span> -1 <span class=o>&amp;&amp;</span> physical_sector &gt; physical_sector_prev + <span class=m>1</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                    <span class=nb>local</span> <span class=nv>start</span><span class=o>=</span><span class=k>$((</span>physical_sector_prev <span class=o>+</span> <span class=m>1</span><span class=k>))</span>
</span></span><span class=line><span class=cl>                    <span class=nb>local</span> <span class=nv>length</span><span class=o>=</span><span class=k>$((</span>physical_sector <span class=o>-</span> start<span class=k>))</span>
</span></span><span class=line><span class=cl>                    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$offset</span><span class=s2> </span><span class=nv>$length</span><span class=s2> linear </span><span class=nv>$part_device</span><span class=s2> </span><span class=nv>$start</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=nv>offset</span><span class=o>=</span><span class=k>$((</span>offset <span class=o>+</span> length<span class=k>))</span>
</span></span><span class=line><span class=cl>                <span class=k>fi</span>
</span></span><span class=line><span class=cl>                <span class=nv>physical_sector_prev</span><span class=o>=</span><span class=nv>$physical_sector</span>
</span></span><span class=line><span class=cl>            <span class=k>done</span>
</span></span><span class=line><span class=cl>            <span class=c1># Final range</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>((</span> physical_sector_prev &lt; total_sectors - <span class=m>1</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                <span class=nb>local</span> <span class=nv>start</span><span class=o>=</span><span class=k>$((</span>physical_sector_prev <span class=o>+</span> <span class=m>1</span><span class=k>))</span>
</span></span><span class=line><span class=cl>                <span class=nb>local</span> <span class=nv>length</span><span class=o>=</span><span class=k>$((</span>total_sectors <span class=o>-</span> start<span class=k>))</span>
</span></span><span class=line><span class=cl>                <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$offset</span><span class=s2> </span><span class=nv>$length</span><span class=s2> linear </span><span class=nv>$part_device</span><span class=s2> </span><span class=nv>$start</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> &gt; <span class=s2>&#34;</span><span class=nv>$table_file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Generating </span><span class=si>${</span><span class=nv>service_file</span><span class=si>}</span><span class=s2>...&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>encoded_id</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>id</span><span class=p>//-/</span><span class=s1>&#39;\\x2d&#39;</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    cat &gt; <span class=s2>&#34;</span><span class=nv>$service_file</span><span class=s2>&#34;</span> <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Prepare dmsetup device for $name
</span></span></span><span class=line><span class=cl><span class=s>After=dev-disk-by${encoded_id}\\x2dpart2.device
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>Type=oneshot
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/bin/sh -c &#39;/bin/cat /etc/dmsetup/${table_file} | /sbin/dmsetup create ${name}&#39;
</span></span></span><span class=line><span class=cl><span class=s>ExecStop=/sbin/dmsetup remove ${name}
</span></span></span><span class=line><span class=cl><span class=s>RemainAfterExit=true
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Done.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;-&gt; Table:   </span><span class=nv>$PWD</span><span class=s2>/</span><span class=nv>$table_file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;-&gt; Service: </span><span class=nv>$PWD</span><span class=s2>/</span><span class=nv>$service_file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>((</span> <span class=si>${#</span><span class=nv>badblock_sectors</span><span class=p>[@]</span><span class=si>}</span> <span class=o>==</span> <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> -e <span class=s2>&#34;\033[1;31mWARNING: badblocks file is empty. Outputting a table for the whole device.\033[0m&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div></details></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Example use:</span>
</span></span><span class=line><span class=cl>&gt; generate_dmsetup_and_systemd_unit scsi-35000c500bf2dc1eb badblocks-4k.txt <span class=m>4096</span>
</span></span><span class=line><span class=cl>&gt; generate_dmsetup_and_systemd_unit /dev/sdc badblocks-4k.txt <span class=m>4096</span>
</span></span><span class=line><span class=cl>&gt; generate_dmsetup_and_systemd_unit /dev/disk/by-id/scsi-35000c500bf2dc1eb badblocks-4k.txt <span class=m>4096</span>
</span></span></code></pre></div><p>Once run, you&rsquo;ll have two files in your current directory:</p><ul><li><code>dm-badblocks-DISK_ID.table</code> &ndash; dmsetup table to avoid badblocks</li><li><code>dm-badblocks-DISK_ID.service</code> &ndash; systemd unit</li></ul><blockquote><p>ℹ️ Info: If, like me, you&rsquo;re using ZFS, it is important that this unit loads <em>before</em> ZFS mounts its devices. Add this line under the <code>[Unit]</code> section to ensure ZFS mounts <em>after</em> dmsetup: <code>Before=zfs-mount.service</code>. You can adjust this as needed for other systems.</p></blockquote><h2 id=4-setting-up-this-system>4. Setting up this system<a hidden class=anchor aria-hidden=true href=#4-setting-up-this-system>#</a></h2><p>Now we will prepare our running system to use the <code>dmsetup</code>. This step should be repeated, if you move the disk to a new system.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Prepare the dmsetup etc directory</span>
</span></span><span class=line><span class=cl>mkdir -p /etc/dmsetup
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Copy the systemd unit</span>
</span></span><span class=line><span class=cl>cp dm-badblocks-DISK_ID.service /etc/systemd/system/
</span></span><span class=line><span class=cl>cp dm-badblocks-DISK_ID.table /etc/dmsetup/
</span></span></code></pre></div><p>Reload the unit, and start it. Verify it doesn&rsquo;t emit any errors.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl start dm-badblocks-DISK_ID
</span></span></code></pre></div><p>Once it works, enable the service to make it auto-start on boot</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl <span class=nb>enable</span> dm-badblocks-DISK_ID
</span></span></code></pre></div><blockquote><p>ℹ️ Info: We copy the table into <code>/etc/dmsetup</code> to ensure that on boot, we don&rsquo;t need to <em>first</em> have the configuration mounted and <em>then</em> be able to load <code>dmsetup</code>. It&rsquo;s better to have fewer dependencies. Step 6 below will copy in the configuration to the first partition for safekeeping, but once thats done, you don&rsquo;t need to mount that partition again (until you move the disk or reinstall the OS of course).</p></blockquote><h2 id=5-preparing-the-configuration-partition>5. Preparing the configuration partition<a hidden class=anchor aria-hidden=true href=#5-preparing-the-configuration-partition>#</a></h2><p>Copy the table, and the systemd unit to your configuration partition.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Make the configuration partition use ext3, a widely supported filesystem</span>
</span></span><span class=line><span class=cl><span class=c1># Emphasis on small - make it 1024 byte blocks, 5% reserved space and fewer inodes</span>
</span></span><span class=line><span class=cl>mkfs.ext3 -b <span class=m>1024</span> -m <span class=m>5</span> -T news /dev/disk/by-id/DISK_ID-part1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mkdir /mnt/tmp
</span></span><span class=line><span class=cl>mount /dev/disk/by-id/DISK_ID-part1 /mnt/tmp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ensure we can identify this setup in the future</span>
</span></span><span class=line><span class=cl><span class=c1># Do this by writing a helpful text in the beginning of our physical device, in the 4k in the beginning that is not used</span>
</span></span><span class=line><span class=cl>e2label /dev/disk/by-id/DISK_ID-part1 <span class=s2>&#34;READ ME&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dd <span class=k>if</span><span class=o>=</span>/dev/zero <span class=nv>of</span><span class=o>=</span>/dev/disk/by-id/DISK_ID-part2 <span class=nv>bs</span><span class=o>=</span><span class=m>4096</span> <span class=nv>count</span><span class=o>=</span><span class=m>1</span> <span class=nv>conv</span><span class=o>=</span>notrunc
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;This disk is managed by dmsetup. Do not use directly. Read the configuration on the first partition for how to use.&#34;</span> <span class=p>|</span> dd <span class=nv>of</span><span class=o>=</span>/dev/disk/by-id/DISK_ID-part2 <span class=nv>bs</span><span class=o>=</span><span class=m>4096</span> <span class=nv>count</span><span class=o>=</span><span class=m>1</span> <span class=nv>conv</span><span class=o>=</span>notrunc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Copy in configuration files</span>
</span></span><span class=line><span class=cl>cp dm-badblocks-DISK_ID.table /mnt/tmp/
</span></span><span class=line><span class=cl>cp dm-badblocks-DISK_ID.service /mnt/tmp/
</span></span><span class=line><span class=cl>cp badblocks-4k.txt /mnt/tmp/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Copy this blogpost to the readme</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s2>&#34;Source: https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/\nGenerated on: %s UTC\n\n---\n&#34;</span> <span class=s2>&#34;</span><span class=k>$(</span>date -u <span class=s1>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class=k>)</span><span class=s2>&#34;</span> &gt; /mnt/tmp/README.txt
</span></span><span class=line><span class=cl>wget https://blog.mbwarez.dk/posts/2025/04/bad-disks-dmsetup/index.md -O - &gt;&gt; /mnt/tmp/README.txt
</span></span></code></pre></div><blockquote><p>ℹ️ Info: The ext3 partition holds the configuration files (<code>dmsetup</code> table, systemd service) so that everything follows the disk when you move it around. Setting its label to <strong>&lsquo;READ ME&rsquo;</strong> hints at its purpose and ensures anyone inspecting the disk understands its role.</p></blockquote><blockquote><p>ℹ️ Info: We&rsquo;ve also ensured that partition 2 is not mountable by conventional means. This ensures that when the disk is moved to a new system, it is not accidentally identified as EXT/ZFS/FAT or whatever might actually be on it.</p></blockquote><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2><p>By using this method, you can salvage a disk with bad sectors and make it usable again without having to replace it. This approach is especially useful when working with filesystems that do not support marking bad blocks, like ZFS.</p><p>You can replicate this process for other disks by adjusting the disk IDs and table filenames.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.mbwarez.dk/tags/linux/>Linux</a></li><li><a href=https://blog.mbwarez.dk/tags/storage/>Storage</a></li><li><a href=https://blog.mbwarez.dk/tags/dmsetup/>Dmsetup</a></li><li><a href=https://blog.mbwarez.dk/tags/zfs/>Zfs</a></li><li><a href=https://blog.mbwarez.dk/tags/badblocks/>Badblocks</a></li></ul><nav class=paginav><a class=prev href=https://blog.mbwarez.dk/posts/2025/05/ha-smart-poll/><span class=title>« Prev</span><br><span>Smart Refresh Schedule for sensors in Home Assistant</span>
</a><a class=next href=https://blog.mbwarez.dk/posts/2025/03/wled-backup-script/><span class=title>Next »</span><br><span>WLED Backup script</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on x" href="https://x.com/intent/tweet/?text=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks&amp;url=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f&amp;hashtags=linux%2cstorage%2cdmsetup%2czfs%2cbadblocks"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f&amp;title=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks&amp;summary=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks&amp;source=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f&title=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on whatsapp" href="https://api.whatsapp.com/send?text=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks%20-%20https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on telegram" href="https://telegram.me/share/url?text=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks&amp;url=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Using dmsetup to Salvage Disks with Bad Blocks on ycombinator" href="https://news.ycombinator.com/submitlink?t=Using%20dmsetup%20to%20Salvage%20Disks%20with%20Bad%20Blocks&u=https%3a%2f%2fblog.mbwarez.dk%2fposts%2f2025%2f04%2fbad-disks-dmsetup%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>© <a href=https://github.com/LordMike>Michael Bisbjerg</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>